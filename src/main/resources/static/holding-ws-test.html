<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>ë³´ìœ  ì¢…ëª© ì‹¤ì‹œê°„ (ì„œë²„ ì¦ë¶„ ê³„ì‚° + í‘¸ì‹œ)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="/js/sockjs.min.js"></script>
  <script src="/js/stomp.umd.min.js"></script>
  <style>
    :root {
      --bg: #f7f7fb;
      --card: #fff;
      --ink: #111;
      --muted: #666;
      --line: #e7e7ef;
      --up: #d93025;
      --down: #0d904f;
    }

    * {
      box-sizing: border-box
    }

    html, body {
      height: 100%
    }

    body {
      margin: 0;
      padding: 20px;
      background: var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Pretendard, Segoe UI, Roboto, Apple SD Gothic Neo, Malgun Gothic, sans-serif;
      color: var(--ink);
      display: flex;
      justify-content: center;
    }

    .wrap {
      width: 100%;
      max-width: 1080px
    }

    h1 {
      margin: 0 0 10px;
      font-size: 22px
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin: 12px 0;
    }

    input, button {
      height: 36px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
    }

    input {
      min-width: 220px
    }

    button {
      cursor: pointer;
      background: #111;
      color: #fff;
      border: none;
    }

    button.sec {
      background: #eee;
      color: #111
    }

    .status {
      margin-left: 6px
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color: #333;
    }

    .summary {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .08);
      min-width: 0;
    }

    .name {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .price {
      font-size: 28px;
      font-weight: 800;
      margin: 2px 0 6px
    }

    .sub {
      font-size: 13px;
      color: var(--muted)
    }

    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px
    }

    .table th {
      font-size: 12px;
      color: #666;
      text-align: left;
      padding: 0 6px
    }

    .rowcard {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
      overflow: hidden;
    }

    .rowgrid {
      display: grid;
      grid-template-columns: minmax(140px, 1fr) 100px 120px 140px 140px 120px;
      gap: 10px;
      align-items: center;
      padding: 12px;
      min-width: 0;
    }

    @media (max-width: 860px) {
      .rowgrid {
        grid-template-columns: 1.2fr .7fr .9fr 1fr 1fr .8fr
      }
    }

    @media (max-width: 640px) {
      .rowgrid {
        grid-template-columns: 1.4fr .8fr .9fr 1fr 1fr
      }

      .col-hide {
        display: none
      }
    }

    .code {
      color: #888;
      margin-left: 4px;
      font-weight: 500
    }

    .right {
      text-align: right
    }

    .mono {
      font-variant-numeric: tabular-nums
    }

    .nowrap {
      white-space: nowrap
    }

    .clip {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap
    }

    .up {
      color: var(--up)
    }

    .down {
      color: var(--down)
    }

    .grid-list {
      display: grid;
      gap: 12px
    }

    pre#log {
      background: #0b1020;
      color: #cde2ff;
      padding: 12px;
      border-radius: 12px;
      height: 160px;
      overflow: auto;
      font-size: 12px;
    }

    .grow {
      flex: 1
    }

    .hint {
      font-size: 12px;
      color: #777;
      margin-left: 6px
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ë³´ìœ  ì¢…ëª© ì‹¤ì‹œê°„ (ì„œë²„ ì¦ë¶„ ê³„ì‚° + í‘¸ì‹œ)</h1>

  <div class="row">
    <input id="inpUserId" placeholder="userId (ì˜ˆ: 5)"/>
    <input id="inpToken" class="grow" placeholder="Bearer í† í°(JWT)"/>
    <button id="btnLoad">ë³´ìœ í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸°</button>
  </div>

  <div class="row">
    <button id="btnConnectWs">Connect (Native WS)</button>
    <button id="btnConnectSock">Connect (SockJS)</button>
    <button id="btnDisconnect" class="sec">Disconnect</button>
    <span id="status" class="status">ğŸ”´ ë¯¸ì—°ê²°</span>
    <span id="transport" class="pill">transport: -</span>
    <span class="hint">ì—°ê²° ì‹œ `/app/portfolio/online`ìœ¼ë¡œ userId ë“±ë¡</span>
  </div>

  <div class="summary" id="summary">
    <div class="card">
      <div class="name">í˜„ê¸ˆìì‚°</div>
      <div class="price mono" id="cashBalance">-</div>
      <div class="sub">ì„œë²„ ê¸°ì¤€ ê³ ì •ê°’</div>
    </div>
    <div class="card">
      <div class="name">íˆ¬ììì‚°(ë§¤ì…ì›ê¸ˆ)</div>
      <div class="price mono" id="investBalance">-</div>
      <div class="sub">ë³´ìœ  ì¢…ëª© ë§¤ì…ê°€ í•©ê³„(ê³ ì •)</div>
    </div>
    <div class="card">
      <div class="name">ì´ ì†ìµ(ì›)</div>
      <div class="price mono" id="totalPnlAmount">-</div>
      <div class="sub">= Î£(í˜„ì¬ê°€Ã—ìˆ˜ëŸ‰ - í‰ê· ë§¤ì…Ã—ìˆ˜ëŸ‰), ì„œë²„ ì¦ë¶„ ê³„ì‚°</div>
    </div>
    <div class="card">
      <div class="name">ì´ ì†ìµë¥ </div>
      <div class="price mono" id="totalPnlRate">-</div>
      <div class="sub">= ì´ì†ìµ Ã· íˆ¬ììì‚° (ê°€ì¤‘), ì„œë²„ í‘¸ì‹œ</div>
    </div>
  </div>

  <div style="margin-top:16px;">
    <table class="table" style="width:100%;">
      <thead>
      <tr>
        <th>ì¢…ëª©</th>
        <th class="right">ìˆ˜ëŸ‰</th>
        <th class="right">í‰ë‹¨</th>
        <th class="right">í˜„ì¬ê°€(ì‹¤ì‹œê°„)</th>
        <th class="right">ì†ìµ(ì›)</th>
        <th class="right col-hide">ì†ìµë¥ </th>
      </tr>
      </thead>
    </table>
    <div id="list" class="grid-list" style="margin-top:6px;"></div>
  </div>

  <h3>ë¡œê·¸</h3>
  <pre id="log"></pre>
</div>

<script>
  const WS_NATIVE_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host
      + '/ws';
  const SOCKJS_FULL_URL = location.origin + '/ws-sockjs';
  let client = null, holdings = null;
  const subs = {};
  const el = (id) => document.getElementById(id);
  const log = (m) => {
    const p = el('log');
    p.textContent += m + "\n";
    p.scrollTop = p.scrollHeight;
  }
  const fmt = (n) => Number(n ?? 0).toLocaleString('ko-KR');
  const pct = (n) => (Number(n) >= 0 ? '+' : '') + (Number(n) * 100).toFixed(2) + '%';
  const STOMP = window.StompJs || window.Stomp;
  const SockJSGlobal = window.SockJS || window.sockjs;

  function getUserId() {
    const v = el('inpUserId').value.trim();
    return v ? Number(v) : NaN;
  }

  // âœ… STOMP ë°©ì‹ ì˜¨ë¼ì¸ ë“±ë¡
  function registerOnline() {
    const uid = getUserId();
    if (!client?.active || !isFinite(uid)) {
      log('âŒ ì˜¨ë¼ì¸ ë“±ë¡ ì‹¤íŒ¨: ì—°ê²°/ìœ ì €ID í™•ì¸');
      return;
    }
    client.publish({destination: '/app/portfolio/online', body: String(uid)});
    log('ğŸ“¡ STOMP /app/portfolio/online => ' + uid);
    window.addEventListener('beforeunload', registerOffline);
  }

  function registerOffline() {
    try {
      const uid = getUserId();
      if (!client?.active || !isFinite(uid)) {
        return;
      }
      client.publish({destination: '/app/portfolio/offline', body: String(uid)});
      log('ğŸ“¡ STOMP /app/portfolio/offline => ' + uid);
    } catch (_) {
    }
  }

  function createClientNative() {
    return new STOMP.Client({
      brokerURL: WS_NATIVE_URL,
      reconnectDelay: 2000,
      debug: (m) => log(m),
      onConnect: () => {
        log('âœ… CONNECTED (native)');
        registerOnline();
        subscribePortfolio();
        subscribeTickers();
      },
      onDisconnect: () => log('ğŸ”» DISCONNECTED'),
      onStompError: (f) => log('âŒ STOMP ERROR: ' + (f.headers?.message || ''))
    });
  }

  function createClientSock() {
    return new STOMP.Client({
      webSocketFactory: () => new SockJSGlobal(SOCKJS_FULL_URL),
      reconnectDelay: 2000,
      debug: (m) => log(m),
      onConnect: () => {
        log('âœ… CONNECTED (SockJS)');
        registerOnline();
        subscribePortfolio();
        subscribeTickers();
      },
      onDisconnect: () => log('ğŸ”» DISCONNECTED')
    });
  }

  async function loadHoldings() {
    const token = el('inpToken').value.trim();
    if (!token) {
      alert('Bearer í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    log('ğŸ“¥ GET /api/mypage/holdings/my');
    const r = await fetch('/api/mypage/holdings/my',
        {headers: {'Authorization': 'Bearer ' + token}});
    if (!r.ok) {
      alert('ë³´ìœ í˜„í™© ìš”ì²­ ì‹¤íŒ¨: ' + r.status);
      return;
    }
    const j = await r.json();
    holdings = j.data;
    renderHoldings(holdings);
    if (client?.active) {
      unsubscribeAll();
      subscribePortfolio();
      subscribeTickers();
      registerOnline();
    }
  }

  function renderHoldings(data) {
    el('cashBalance').textContent = fmt(data.portfolio.cashBalance);
    el('investBalance').textContent = fmt(data.portfolio.totalInvestment);
    el('totalPnlAmount').textContent = fmt(data.portfolio.totalPnlAmount);
    el('totalPnlRate').textContent = pct(data.portfolio.totalPnlRate);
    const box = el('list');
    box.innerHTML = '';
    (data.items || []).forEach(item => {
      const row = document.createElement('div');
      row.className = 'rowcard';
      row.id = 'row-' + item.symbol;
      row.innerHTML = `
        <div class="rowgrid">
          <div class="clip"><div class="name clip">${item.name}<span class="code">(${item.symbol})</span></div></div>
          <div class="right mono nowrap" id="q-${item.symbol}">${fmt(item.quantity)}</div>
          <div class="right mono nowrap" id="avg-${item.symbol}">${fmt(item.avgPrice)}</div>
          <div class="right mono price nowrap" id="cur-${item.symbol}">${fmt(item.currentPrice)}</div>
          <div class="right mono nowrap" id="pnl-${item.symbol}">${fmt(item.pnlAmount)}</div>
          <div class="right mono nowrap col-hide" id="rate-${item.symbol}">${pct(item.pnlRate)}</div>
        </div>`;
      box.appendChild(row);
      updateRowColor(item.symbol, item.pnlAmount);
    });
  }

  function updateRowColor(symbol, pnlAmount) {
    const els = ['cur-', 'pnl-', 'rate-'].map(p => el(p + symbol));
    const up = Number(pnlAmount) >= 0;
    els.forEach(e => {
      if (e) {
        e.classList.remove('up', 'down');
        e.classList.add(up ? 'up' : 'down');
      }
    });
  }

  function subscribeTickers() {
    if (!client?.active || !holdings?.items) {
      return;
    }
    holdings.items.forEach(it => {
      const topic = '/topic/ticker/' + it.symbol;
      if (subs[it.symbol]) {
        return;
      }
      subs[it.symbol] = client.subscribe(topic, (msg) => {
        const t = JSON.parse(msg.body);
        const cur = Number(t.tradePrice);
        el('cur-' + it.symbol).textContent = fmt(cur);
        const qty = Number(it.quantity), avg = Number(it.avgPrice);
        const pnlAmt = cur * qty - avg * qty, pnlRate = avg === 0 ? 0 : (pnlAmt / (avg * qty));
        el('pnl-' + it.symbol).textContent = fmt(pnlAmt);
        const rateEl = el('rate-' + it.symbol);
        if (rateEl) {
          rateEl.textContent = pct(pnlRate);
        }
        updateRowColor(it.symbol, pnlAmt);
      });
      log('ğŸ§· SUB ' + topic);
    });
  }

  function subscribePortfolio() {
    const uid = getUserId();
    if (!client?.active || !isFinite(uid)) {
      return;
    }
    const topic = '/topic/portfolio/' + uid;
    if (subs['portfolio']) {
      subs['portfolio'].unsubscribe();
    }
    subs['portfolio'] = client.subscribe(topic, (msg) => {
      const p = JSON.parse(msg.body);
      el('totalPnlAmount').textContent = fmt(p.totalPnlAmount);
      el('totalPnlRate').textContent = pct(p.totalPnlRate);
    });
    log('ğŸ§· SUB ' + topic);
  }

  function unsubscribeAll() {
    Object.values(subs).forEach(s => {
      try {
        s.unsubscribe();
      } catch (_) {
      }
    });
    for (const k in subs) {
      delete subs[k];
    }
  }

  el('btnLoad').onclick = loadHoldings;
  el('btnConnectWs').onclick = () => {
    if (client?.active) {
      client.deactivate();
    }
    client = createClientNative();
    client.activate();
  };
  el('btnConnectSock').onclick = () => {
    if (client?.active) {
      client.deactivate();
    }
    client = createClientSock();
    client.activate();
  };
  el('btnDisconnect').onclick = () => {
    registerOffline();
    if (client?.active) {
      client.deactivate();
    }
    unsubscribeAll();
  };
</script>
</body>
</html>