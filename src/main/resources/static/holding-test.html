<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>ë³´ìœ  ì¢…ëª© ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="/js/sockjs.min.js"></script>
  <script src="/js/stomp.umd.min.js"></script>
  <style>
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Pretendard, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center
    }

    .wrap {
      width: 100%;
      max-width: 980px
    }

    h1 {
      margin: 0 0 6px;
      font-size: 22px
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin: 12px 0
    }

    input, button {
      height: 36px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid #ddd
    }

    button {
      cursor: pointer;
      background: #111;
      color: #fff;
      border: none
    }

    button.sec {
      background: #eee;
      color: #111
    }

    .status {
      margin-left: 8px
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fff;
      color: #333
    }

    .grid {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .08)
    }

    .name {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 18px
    }

    .code {
      color: #888;
      margin-left: 4px
    }

    .price {
      font-size: 28px;
      font-weight: 800;
      margin: 2px 0 6px
    }

    .sub {
      font-size: 14px;
      color: #555;
      margin-bottom: 4px
    }

    .up {
      color: #d93025
    }

    .down {
      color: #0d904f
    }

    .table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px
    }

    .table th {
      font-size: 12px;
      color: #666;
      text-align: left;
      padding: 0 6px
    }

    .rowcard {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06)
    }

    .rowgrid {
      display: grid;
      grid-template-columns:140px 100px 100px 110px 110px 110px;
      gap: 10px;
      align-items: center;
      padding: 12px
    }

    .right {
      text-align: right
    }

    .mono {
      font-variant-numeric: tabular-nums
    }

    .summary {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 14px
    }

    .summary .card {
      flex: 1;
      min-width: 220px
    }

    pre#log {
      background: #0b1020;
      color: #cde2ff;
      padding: 12px;
      border-radius: 12px;
      height: 160px;
      overflow: auto
    }

    /* ==== FIX: ë³´ìœ  ì¢…ëª© ì¤„ ì˜ë¦¼ ë°©ì§€ ==== */

    /* ë¦¬ìŠ¤íŠ¸ëŠ” í•„ìš”í•œ ê²½ìš° ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
    #list {
      display: block;
      overflow-x: auto; /* í™”ë©´ ì¢ì„ ë•Œë„ ì˜ë¦¬ì§€ ì•Šê³  ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
      padding-bottom: 4px;
    }

    /* ì¹´ë“œ ë‚´ë¶€ ê·¸ë¦¬ë“œë¥¼ ê³ ì • px â†’ ìœ ë™ fr ë¡œ ë³€ê²½í•´ ë°˜ì‘í˜• ì •ë ¬ */
    .rowgrid {
      /* ì¢…ëª© | ìˆ˜ëŸ‰ | í‰ë‹¨ | í˜„ì¬ê°€ | ì†ìµ(ì›) | ì†ìµë¥  */
      grid-template-columns: 1.4fr 0.6fr 0.8fr 1fr 1fr 0.8fr;
      column-gap: 14px;
      min-width: 720px; /* ì•„ì£¼ ì¢ì€ í™”ë©´ì—ì„œëŠ” ìŠ¤í¬ë¡¤ë¡œ ë³´ì´ë„ë¡ ì•ˆì „ í­ */
    }

    /* ìˆ«ì í°íŠ¸ê°€ ë„ˆë¬´ ì»¤ì„œ ì¤„ë°”ê¿ˆ/ì˜ë¦¼ ë‚˜ëŠ” ê²ƒ ì™„í™” */
    .price {
      font-size: 24px; /* ê¸°ì¡´ 28px â†’ 24px */
    }

    /* íƒ€ì´í‹€/ê°’ì´ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì‘ì€ í™”ë©´ ë³´ì • */
    @media (max-width: 900px) {
      .rowgrid {
        min-width: 680px;
      }

      .price {
        font-size: 22px;
      }
    }

    @media (max-width: 600px) {
      .rowgrid {
        min-width: 640px;
      }

      .price {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ë³´ìœ  ì¢…ëª© ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</h1>
  <div class="row">
    <button id="btnLoad">ë³´ìœ í˜„í™© ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="btnConnectWs">Connect (Native WS)</button>
    <button id="btnConnectSock">Connect (SockJS)</button>
    <button id="btnDisconnect" class="sec">Disconnect</button>
    <span id="status" class="status">ğŸ”´ ë¯¸ì—°ê²°</span>
    <span id="transport" class="pill">transport: -</span>
  </div>

  <div class="summary" id="summary">
    <div class="card">
      <div class="name">í˜„ê¸ˆìì‚°</div>
      <div class="price mono" id="cashBalance">-</div>
      <div class="sub">ì„œë²„ ê¸°ì¤€ ê³ ì •ê°’</div>
    </div>
    <div class="card">
      <div class="name">íˆ¬ììì‚°(ë§¤ì…ì›ê¸ˆ)</div>
      <div class="price mono" id="investBalance">-</div>
      <div class="sub">ë³´ìœ  ì¢…ëª© ë§¤ì…ê°€ í•©ê³„(ê³ ì •)</div>
    </div>
    <div class="card">
      <div class="name">ì´ ì†ìµ(ì›)</div>
      <div class="price mono" id="totalPnlAmount">-</div>
      <div class="sub">= Î£(í˜„ì¬ê°€Ã—ìˆ˜ëŸ‰ - í‰ê· ë§¤ì…Ã—ìˆ˜ëŸ‰)</div>
    </div>
    <div class="card">
      <div class="name">ì´ ì†ìµë¥ </div>
      <div class="price mono" id="totalPnlRate">-</div>
      <div class="sub">= ì´ì†ìµ Ã· íˆ¬ììì‚° (ê°€ì¤‘)</div>
    </div>
  </div>

  <div style="margin-top:16px;">
    <table class="table" style="width:100%;">
      <thead>
      <tr>
        <th>ì¢…ëª©</th>
        <th class="right">ìˆ˜ëŸ‰</th>
        <th class="right">í‰ë‹¨</th>
        <th class="right">í˜„ì¬ê°€(ì‹¤ì‹œê°„)</th>
        <th class="right">ì†ìµ(ì›)</th>
        <th class="right">ì†ìµë¥ </th>
      </tr>
      </thead>
    </table>
    <div id="list" class="grid" style="margin-top:6px;"></div>
  </div>

  <h3>ë¡œê·¸</h3>
  <pre id="log"></pre>
</div>

<script>
  // ====== í™˜ê²½ URL ======
  const WS_NATIVE_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host
      + '/ws';
  const SOCKJS_FULL_URL = location.origin + '/ws-sockjs';

  // ====== ì „ì—­ ìƒíƒœ ======
  let client = null;
  let currentTransport = '-';
  let holdings = null; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì´ˆê¸° ë³´ìœ ë°ì´í„°
  const subs = {};     // ì‹¬ë³¼ë³„ êµ¬ë… í•¸ë“¤

  // ====== DOM ======
  const el = (id) => document.getElementById(id);
  const log = (m) => {
    const p = el('log');
    p.textContent += m + "\n";
    p.scrollTop = p.scrollHeight;
  }
  const setStatus = (ok) => el('status').textContent = ok ? 'ğŸŸ¢ ì—°ê²°ë¨' : 'ğŸ”´ ë¯¸ì—°ê²°';
  const setTransport = (t) => {
    currentTransport = t;
    el('transport').textContent = 'transport: ' + t;
  }
  const fmt = (n) => Number(n ?? 0).toLocaleString('ko-KR');
  const pct = (n) => (Number(n) >= 0 ? '+' : '') + (Number(n) * 100).toFixed(2) + '%';

  // ê°€ë“œ: 0ìœ¼ë¡œ ë‚˜ëˆ” ë°©ì§€
  const safeDiv = (num, den) => {
    const d = Number(den);
    if (!isFinite(d) || Math.abs(d) < 1e-9) {
      return 0;
    }
    return Number(num) / d;
  };

  // ====== STOMP íŒ©í† ë¦¬ ======
  const STOMP = window.StompJs || window.Stomp;
  const SockJSGlobal = window.SockJS || window.sockjs;

  function createClientNative() {
    return new STOMP.Client({
      brokerURL: WS_NATIVE_URL,
      reconnectDelay: 2000,
      debug: (m) => log(m),
      onConnect: () => {
        setStatus(true);
        setTransport('native');
        log('âœ… CONNECTED(native)');
        subscribeAll();
      },
      onDisconnect: () => {
        setStatus(false);
        log('ğŸ”» DISCONNECTED');
      },
      onStompError: (f) => {
        log('âŒ STOMP ERROR: ' + (f.headers?.message || ''));
        log(f.body || '');
      },
      onWebSocketError: (e) => log('âŒ WS ERROR: ' + (e?.message || e)),
    });
  }

  function createClientSock() {
    if (!SockJSGlobal) {
      log('âŒ SockJS ëˆ„ë½');
      return null;
    }
    return new STOMP.Client({
      webSocketFactory: () => new SockJSGlobal(SOCKJS_FULL_URL),
      reconnectDelay: 2000,
      debug: (m) => log(m),
      onConnect: () => {
        setStatus(true);
        setTransport('sockjs');
        log('âœ… CONNECTED(sockjs)');
        subscribeAll();
      },
      onDisconnect: () => {
        setStatus(false);
        log('ğŸ”» DISCONNECTED');
      },
      onStompError: (f) => {
        log('âŒ STOMP ERROR: ' + (f.headers?.message || ''));
        log(f.body || '');
      },
      onWebSocketError: (e) => log('âŒ WS ERROR: ' + (e?.message || e)),
    });
  }

  // ====== ë³´ìœ í˜„í™© ìµœì´ˆ ë¡œë“œ ======
  async function loadHoldings() {
    log('ğŸ“¥ fetching /api/mypage/holdings/my ...');
    const token = "hereisuseraccesstoken"; // ğŸ” DevTools -> Application -> Local Storage -> token ë“±ì—ì„œ ë³µì‚¬
    const r = await fetch('/api/mypage/holdings/my', {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    const j = await r.json();
    holdings = j.data; // {items, portfolio}
    renderHoldings(holdings);
    // ì—°ê²°ë˜ì–´ ìˆë‹¤ë©´ êµ¬ë… ìƒˆë¡œ êµ¬ì„±
    if (client?.active) {
      unsubscribeAll();
      subscribeAll();
    }
  }

  // ====== ë Œë” ======
  function renderHoldings(data) {
    // ìƒë‹¨ ìš”ì•½(í˜„ê¸ˆ/íˆ¬ì/ì´ì†ìµ/ì´ì†ìµë¥ ) â€” ì„œë²„ê°’ ë°˜ì˜
    el('cashBalance').textContent = fmt(data.portfolio.cashBalance);
    el('investBalance').textContent = fmt(data.portfolio.totalInvestment);
    el('totalPnlAmount').textContent = fmt(data.portfolio.totalPnlAmount);
    el('totalPnlRate').textContent = pct(data.portfolio.totalPnlRate);

    // ë¦¬ìŠ¤íŠ¸
    const box = el('list');
    box.innerHTML = '';
    (data.items || []).forEach(item => {
      const row = document.createElement('div');
      row.className = 'rowcard';
      row.id = 'row-' + item.symbol;

      row.innerHTML = `
        <div class="rowgrid">
          <div>
            <div class="name">${item.name}<span class="code">(${item.symbol})</span></div>
          </div>
          <div class="right mono" id="q-${item.symbol}">${fmt(item.quantity)}</div>
          <div class="right mono" id="avg-${item.symbol}">${fmt(item.avgPrice)}</div>
          <div class="right mono price" id="cur-${item.symbol}">${fmt(item.currentPrice)}</div>
          <div class="right mono" id="pnl-${item.symbol}">${fmt(item.pnlAmount)}</div>
          <div class="right mono" id="rate-${item.symbol}">${pct(item.pnlRate)}</div>
        </div>
      `;
      box.appendChild(row);
      updateRowColor(item.symbol, item.pnlAmount); // ìƒ‰ìƒ
    });
  }

  function updateRowColor(symbol, pnlAmount) {
    const priceEl = el('cur-' + symbol);
    const pnlEl = el('pnl-' + symbol);
    const rateEl = el('rate-' + symbol);
    const up = Number(pnlAmount) >= 0;
    [priceEl, pnlEl, rateEl].forEach(e => {
      if (!e) {
        return;
      }
      e.classList.remove('up', 'down');
      e.classList.add(up ? 'up' : 'down');
    });
  }

  // ====== êµ¬ë…/ì‹¤ì‹œê°„ ê³„ì‚° ======
  function subscribeAll() {
    if (!client?.active || !holdings?.items) {
      return;
    }
    holdings.items.forEach(it => {
      const topic = '/topic/ticker/' + it.symbol;
      if (subs[it.symbol]) {
        return;
      } // ì´ë¯¸ êµ¬ë… ì¤‘
      subs[it.symbol] = client.subscribe(topic, (msg) => {
        try {
          const t = JSON.parse(msg.body); // TickerMessage
          // í˜„ì¬ê°€ ê°±ì‹ 
          const cur = Number(t.tradePrice);
          el('cur-' + it.symbol).textContent = fmt(cur);

          // ë³´ìœ  ìˆ˜ëŸ‰/í‰ë‹¨
          const qty = Number(it.quantity);
          const avg = Number(it.avgPrice);

          // ì†ìµ ì›/ë¥  ì¬ê³„ì‚°
          const invest = avg * qty;
          const current = cur * qty;
          const pnlAmt = current - invest;
          const pnlRate = safeDiv(pnlAmt, invest);

          el('pnl-' + it.symbol).textContent = fmt(pnlAmt);
          el('rate-' + it.symbol).textContent = pct(pnlRate);
          updateRowColor(it.symbol, pnlAmt);

          // í¬íŠ¸í´ë¦¬ì˜¤ í•©ê³„(ê°€ì¤‘)
          recalcPortfolio();
        } catch (e) {
          log('parse err: ' + e.message);
        }
      }, {id: 'sub-' + it.symbol});
      log('ğŸ§· SUB ' + topic);
    });
  }

  function unsubscribeAll() {
    Object.values(subs).forEach(s => s.unsubscribe());
    for (const k in subs) {
      delete subs[k];
    }
  }

  function recalcPortfolio() {
    if (!holdings) {
      return;
    }
    const totalInvestment = Number(holdings.portfolio.totalInvestment || 0); // ê³ ì •
    const cashBalance = Number(holdings.portfolio.cashBalance || 0);     // ê³ ì •

    // Î£ pnlAmount (DOMì—ì„œ ì½ì–´ í•©ì‚°)
    let sumPnl = 0;
    (holdings.items || []).forEach(it => {
      const pnlText = el('pnl-' + it.symbol)?.textContent?.replaceAll(',', '') || '0';
      sumPnl += Number(pnlText);
    });

    // ì´ì†ìµë¥  = ì´ì†ìµ / íˆ¬ììì‚° (ê°€ì¤‘)
    const totalRate = safeDiv(sumPnl, totalInvestment);

    el('totalPnlAmount').textContent = fmt(sumPnl);
    el('totalPnlRate').textContent = pct(totalRate);

    // ì´ ìì‚°(í‘œì‹œìš©) = íˆ¬ììì‚° + í˜„ê¸ˆìì‚° (ì„¤ëª…ìƒ ê³ ì •)
    el('cashBalance').textContent = fmt(cashBalance);
    el('investBalance').textContent = fmt(totalInvestment);
  }

  // ====== ë²„íŠ¼ ======
  el('btnLoad').onclick = loadHoldings;
  el('btnConnectWs').onclick = () => {
    if (!STOMP) {
      return;
    }
    if (client?.active) {
      client.deactivate();
    }
    client = createClientNative();
    client.activate();
  };
  el('btnConnectSock').onclick = () => {
    if (!STOMP) {
      return;
    }
    if (client?.active) {
      client.deactivate();
    }
    client = createClientSock();
    client?.activate();
  };
  el('btnDisconnect').onclick = () => client?.deactivate();

  // ìë™ ì‹œí€€ìŠ¤(ì„ íƒ): ì§„ì… ì‹œ ë³´ìœ í˜„í™© ë¨¼ì € ë¡œë“œ
  loadHoldings();
</script>
</body>
</html>