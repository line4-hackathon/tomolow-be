<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë­í‚¹ ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- ë°°í¬ ì„œë²„ì— ì˜¬ë ¤ë‘” js ì‚¬ìš© (ê´€ì‹¬ì¢…ëª© ì˜ˆì œì™€ ë™ì¼) -->
  <script src="/js/sockjs.min.js"></script>
  <script src="/js/stomp.umd.min.js"></script>

  <style>
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Pretendard, sans-serif;
      background: #f7f8fa;
      margin: 0;
      padding: 32px;
    }

    h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 18px;
      align-items: center;
    }

    select, input, button {
      height: 34px;
      border-radius: 10px;
      border: 1px solid #ccc;
      padding: 0 10px;
      font-size: 14px;
    }

    button {
      background: #222;
      color: white;
      cursor: pointer;
      border: none;
    }

    #status {
      font-size: 13px;
      color: #555;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    th, td {
      padding: 8px 10px;
      font-size: 13px;
      border-bottom: 1px solid #eee;
      text-align: right;
    }

    th:nth-child(2),
    th:nth-child(3),
    td:nth-child(2),
    td:nth-child(3) {
      text-align: left;
    }

    th {
      background: #fafafa;
      font-weight: 600;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .up {
      color: #d93025;
    }
    .down {
      color: #0d904f;
    }

    pre#log {
      margin-top: 16px;
      background: #111;
      color: #cde2ff;
      padding: 10px;
      border-radius: 10px;
      height: 120px;
      overflow-y: auto;
      font-size: 11px;
    }
  </style>
</head>
<body>
<h2>ğŸ“Š ë­í‚¹ ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</h2>

<div class="controls">
  <span>ë­í‚¹ íƒ€ì…:</span>
  <select id="rankType">
    <option value="turnover">ê±°ë˜ëŒ€ê¸ˆ (turnover)</option>
    <option value="volume">ê±°ë˜ëŸ‰ (volume)</option>
    <option value="gainers">ê¸‰ìƒìŠ¹ (gainers)</option>
    <option value="losers">ê¸‰í•˜ë½ (losers)</option>
  </select>

  <span>limit:</span>
  <input id="limit" type="number" min="1" max="100" value="20" style="width:70px;">

  <button id="btnStart">ì´ˆê¸° ì¡°íšŒ + ì‹¤ì‹œê°„ êµ¬ë…</button>
  <button id="btnDisconnect" disabled>Disconnect</button>
</div>

<div id="status">ìƒíƒœ: ì—°ê²° ì•ˆ ë¨</div>

<table>
  <thead>
  <tr>
    <th>#</th>
    <th>ì‹¬ë³¼</th>
    <th>ì´ë¦„</th>
    <th>í˜„ì¬ê°€</th>
    <th>ë“±ë½ë¥ </th>
    <th>ë“±ë½ê¸ˆì•¡</th>
  </tr>
  </thead>
  <tbody id="tbody">
  <!-- ë°ì´í„° ë Œë”ë§ ì˜ì—­ -->
  </tbody>
</table>

<pre id="log"></pre>

<script>
  // ë°±ì—”ë“œ API / WS ì£¼ì†Œ (ë¡œì»¬/ë°°í¬ ëª¨ë‘ ìë™ ëŒ€ì‘)
  const API_BASE = location.origin; // ì˜ˆ: http://localhost:8080, https://api.tomolow.store
  const WS_URL =
      (location.protocol === 'https:' ? 'wss://' : 'ws://') +
      location.host +
      '/ws'; // ì˜ˆ: wss://tomolow.store/ws

  let stompClient = null;
  let currentSub = null;

  const el = (id) => document.getElementById(id);
  const log = (m) => {
    const box = el('log');
    box.textContent += m + '\n';
    box.scrollTop = box.scrollHeight;
  };

  const fmt = (n) => Number(n ?? 0).toLocaleString('ko-KR');
  const pct = (n) => {
    const v = Number(n || 0);
    const sign = v >= 0 ? '+' : '';
    return sign + (v * 100).toFixed(2) + '%';
  };

  // 1) RESTë¡œ ì´ˆê¸° ë­í‚¹ í•œë²ˆ ë°›ì•„ì˜¤ê¸°
  async function loadInitialRank(type, limit) {
    const url = `${API_BASE}/api/rank/${type}?limit=${limit}`;
    log('ğŸ“¡ GET ' + url);

    const res = await fetch(url);
    if (!res.ok) {
      log('âŒ ë­í‚¹ ìš”ì²­ ì‹¤íŒ¨: ' + res.status);
      return [];
    }
    const body = await res.json();
    // BaseResponse.success("msg", data) í˜•íƒœë¼ê³  ê°€ì • â†’ data í•„ë“œì— ë¦¬ìŠ¤íŠ¸
    const items = body.data || [];
    log(`âœ… ì´ˆê¸° ë­í‚¹ ${items.length}ê±´ ìˆ˜ì‹ `);
    render(items, limit);
    return items;
  }

  // 2) WebSocket + STOMP ì—°ê²°
  function connectStomp(type, limit) {
    if (stompClient) {
      // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
      try {
        if (currentSub) currentSub.unsubscribe();
      } catch {}
      stompClient.deactivate();
    }

    stompClient = new StompJs.Client({
      brokerURL: WS_URL,
      reconnectDelay: 2000,
      debug: (msg) => log(msg),
      onConnect: () => {
        log('âœ… STOMP ì—°ê²° ì„±ê³µ: ' + WS_URL);
        el('status').textContent = `ìƒíƒœ: ì—°ê²° ì™„ë£Œ, /topic/rank/${type} êµ¬ë… ì¤‘`;
        el('btnDisconnect').disabled = false;
        subscribeRank(type, limit);
      },
      onStompError: (frame) => {
        log('âŒ STOMP ERROR: ' + frame.headers['message']);
      },
      onDisconnect: () => {
        log('ğŸ”» ì—°ê²° ì¢…ë£Œë¨');
        el('status').textContent = 'ìƒíƒœ: ì—°ê²° ëŠê¹€';
        el('btnDisconnect').disabled = true;
      }
    });

    stompClient.activate();
  }

  // 3) ë­í‚¹ í† í”½ êµ¬ë… (/topic/rank/{type})
  function subscribeRank(type, limit) {
    if (!stompClient || !stompClient.active) return;

    const topic = `/topic/rank/${type}`;

    if (currentSub) {
      currentSub.unsubscribe();
    }

    currentSub = stompClient.subscribe(topic, (msg) => {
      try {
        const list = JSON.parse(msg.body); // RankingServiceì—ì„œ JSON ë¬¸ìì—´ ë³´ëƒ„
        log(`ğŸ“¥ PUSH ${topic} length=${list.length}`);
        render(list, limit);
      } catch (e) {
        console.error(e);
        log('âŒ JSON íŒŒì‹± ì—ëŸ¬: ' + e.message);
      }
    });

    log('ğŸ§· SUB ' + topic);
  }

  // 4) í…Œì´ë¸” ë Œë”ë§
  function render(items, limit) {
    const tbody = el('tbody');
    tbody.innerHTML = '';

    (items || []).slice(0, limit).forEach((it, idx) => {
      const tr = document.createElement('tr');

      const rankTd = document.createElement('td');
      rankTd.textContent = idx + 1;

      const symTd = document.createElement('td');
      symTd.textContent = it.symbol ?? '-';

      const nameTd = document.createElement('td');
      nameTd.textContent = it.name ?? '-';

      const priceTd = document.createElement('td');
      const price = it.price ?? 0;
      priceTd.textContent = fmt(price);

      const rateTd = document.createElement('td');
      const rate = it.changeRate ?? 0;
      rateTd.textContent = pct(rate);
      rateTd.className = rate > 0 ? 'up' : rate < 0 ? 'down' : '';

      const chgTd = document.createElement('td');
      const chg = it.changePrice ?? 0;
      chgTd.textContent = fmt(chg);

      tr.appendChild(rankTd);
      tr.appendChild(symTd);
      tr.appendChild(nameTd);
      tr.appendChild(priceTd);
      tr.appendChild(rateTd);
      tr.appendChild(chgTd);

      tbody.appendChild(tr);
    });
  }

  // 5) ë²„íŠ¼ ì´ë²¤íŠ¸
  el('btnStart').onclick = async () => {
    const type = el('rankType').value;
    const limit = Number(el('limit').value || 20);

    el('status').textContent = 'ìƒíƒœ: ì´ˆê¸° ë­í‚¹ ì¡°íšŒ ì¤‘...';
    await loadInitialRank(type, limit);
    connectStomp(type, limit);
  };

  el('btnDisconnect').onclick = () => {
    if (stompClient) {
      try {
        if (currentSub) currentSub.unsubscribe();
      } catch {}
      stompClient.deactivate();
    }
    el('status').textContent = 'ìƒíƒœ: ì—°ê²° ì•ˆ ë¨';
    el('btnDisconnect').disabled = true;
  };

  // íƒ€ì… ë°”ê¾¸ë©´, ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ë‹¤ì‹œ êµ¬ë…
  el('rankType').addEventListener('change', () => {
    if (stompClient && stompClient.active) {
      const type = el('rankType').value;
      const limit = Number(el('limit').value || 20);
      subscribeRank(type, limit);
      el('status').textContent = `ìƒíƒœ: ì—°ê²° ì™„ë£Œ, /topic/rank/${type} êµ¬ë… ì¤‘`;
    }
  });
</script>
</body>
</html>