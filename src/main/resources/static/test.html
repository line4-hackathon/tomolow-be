<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>STOMP ì‹¤ì‹œê°„ ì‹œì„¸ í…ŒìŠ¤íŠ¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- ì •ì  ë¦¬ì†ŒìŠ¤: /src/main/resources/static/js/... -->
  <script src="/js/sockjs.min.js"></script>
  <script src="/js/stomp.umd.min.js"></script>

  <style>
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", Pretendard, sans-serif;
      background: #fafafa;
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center
    }

    .wrap {
      width: 100%;
      max-width: 880px
    }

    h1 {
      margin: 0 0 12px;
      font-size: 22px
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center
    }

    input, button, select {
      height: 36px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid #ddd
    }

    button {
      cursor: pointer;
      background: #111;
      color: #fff;
      border: none
    }

    button.sec {
      background: #eee;
      color: #111;
      border: 1px solid #ddd
    }

    .status {
      margin-left: 8px
    }

    .grid {
      display: grid;
      grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .08)
    }

    .name {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 18px
    }

    .code {
      color: #888;
      font-weight: 400;
      margin-left: 4px
    }

    .price {
      font-size: 34px;
      font-weight: 800;
      margin: 2px 0 6px
    }

    .sub {
      font-size: 14px;
      color: #555;
      margin-bottom: 4px
    }

    .time {
      font-size: 12px;
      color: #999;
      text-align: right;
      margin-top: 4px
    }

    .up {
      color: #d93025
    }

    .down {
      color: #0d904f
    }

    pre#log {
      background: #0b1020;
      color: #cde2ff;
      padding: 12px;
      border-radius: 12px;
      height: 200px;
      overflow: auto
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #fff;
      color: #333
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>STOMP ì‹¤ì‹œê°„ ì‹œì„¸ í…ŒìŠ¤íŠ¸ (/topic/ticker/{market})</h1>

  <div class="row">
    <label>ë§ˆì¼“:</label>
    <select id="market">
      <option value="KRW-BTC">KRW-BTC (ë¹„íŠ¸ì½”ì¸)</option>
      <option value="KRW-ETH">KRW-ETH (ì´ë”ë¦¬ì›€)</option>
      <option value="KRW-XRP">KRW-XRP (ë¦¬í”Œ)</option>
      <option value="KRW-ADA">KRW-ADA (ì—ì´ë‹¤)</option>
      <option value="KRW-SOL">KRW-SOL (ì†”ë¼ë‚˜)</option>
      <option value="KRW-DOT">KRW-DOT (í´ì¹´ë‹·)</option>
      <option value="KRW-DOGE">KRW-DOGE (ë„ì§€ì½”ì¸)</option>
      <option value="KRW-LINK">KRW-LINK (ì²´ì¸ë§í¬)</option>
    </select>

    <button id="btnConnectWs">Connect (Native WS)</button>
    <button id="btnConnectSock">Connect (SockJS)</button>
    <button id="btnSubscribe">Subscribe</button>
    <button id="btnDisconnect" class="sec">Disconnect</button>

    <span id="status" class="status">ğŸ”´ ë¯¸ì—°ê²°</span>
    <span id="transport" class="pill">transport: -</span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="name" id="name">ë¹„íŠ¸ì½”ì¸ <span class="code" id="code">(KRW-BTC)</span></div>
      <div id="price" class="price">-</div>
      <div id="change" class="sub">ì „ì¼ëŒ€ë¹„ -</div>
      <div id="prev" class="sub">ì „ì¼ ì¢…ê°€: -</div>
      <div id="vol" class="sub">ëˆ„ì  ê±°ë˜ëŸ‰(24h): -</div>
      <div id="time" class="time"></div>
    </div>
  </div>

  <h3>ë¡œê·¸</h3>
  <pre id="log"></pre>
</div>

<script>
  // ====== í™˜ê²½ë³„ ìë™ URL ======
  const WS_NATIVE_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host
      + '/ws';
  const SOCKJS_FULL_URL = location.origin + '/ws-sockjs';

  let client = null;
  let currentSub = null;
  let currentTransport = "-";

  // ====== DOM/ìœ í‹¸ ======
  const el = (id) => document.getElementById(id);
  const log = (m) => {
    const p = el('log');
    p.textContent += m + "\n";
    p.scrollTop = p.scrollHeight;
  };
  const setStatus = (ok) => el('status').textContent = ok ? 'ğŸŸ¢ ì—°ê²°ë¨' : 'ğŸ”´ ë¯¸ì—°ê²°';
  const setTransport = (t) => {
    currentTransport = t;
    el('transport').textContent = 'transport: ' + t;
  };

  const fmtPrice = (n) => Number(n ?? 0).toLocaleString('ko-KR');
  const fmtPct = (n) => `${(Number(n) >= 0 ? '+' : '')}${(Number(n) * 100).toFixed(2)}%`;
  const fmtWon = (n) => `${(Number(n) >= 0 ? '+' : '')}${Number(n ?? 0).toLocaleString('ko-KR')}ì›`;
  const fmtVol = (n) => Number(n ?? 0).toFixed(4);

  // ====== STOMP/SockJS ======
  const STOMP = window.StompJs || window.Stomp;
  const SockJSGlobal = window.SockJS || window.sockjs;
  if (!STOMP) {
    log("âŒ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. /js/stomp.umd.min.js í™•ì¸");
  }

  function createClientNative() {
    return new STOMP.Client({
      brokerURL: WS_NATIVE_URL,
      reconnectDelay: 2000,
      debug: (m) => log(m),
      onConnect: () => {
        setStatus(true);
        setTransport('native');
        log('âœ… STOMP CONNECTED (native)');
      },
      onDisconnect: () => {
        setStatus(false);
        log('ğŸ”» DISCONNECTED');
      },
      onStompError: (f) => {
        log('âŒ STOMP ERROR: ' + (f.headers?.message || ''));
        log(f.body || '');
      },
      onWebSocketError: (e) => log('âŒ WS ERROR: ' + (e?.message || e)),
    });
  }

  function createClientSockJS() {
    if (!SockJSGlobal) {
      log("âŒ SockJS ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. /js/sockjs.min.js í™•ì¸");
      return null;
    }
    return new STOMP.Client({
      webSocketFactory: () => new SockJSGlobal(SOCKJS_FULL_URL),
      reconnectDelay: 2000,
      debug: (m) => log(m),
      onConnect: () => {
        setStatus(true);
        setTransport('sockjs');
        log('âœ… STOMP CONNECTED (sockjs)');
      },
      onDisconnect: () => {
        setStatus(false);
        log('ğŸ”» DISCONNECTED');
      },
      onStompError: (f) => {
        log('âŒ STOMP ERROR: ' + (f.headers?.message || ''));
        log(f.body || '');
      },
      onWebSocketError: (e) => log('âŒ WS ERROR: ' + (e?.message || e)),
    });
  }

  function connectNative() {
    if (!STOMP) {
      return;
    }
    if (client?.active) {
      client.deactivate();
    }
    client = createClientNative();
    client.activate();
  }

  function connectSockJS() {
    if (!STOMP) {
      return;
    }
    if (client?.active) {
      client.deactivate();
    }
    client = createClientSockJS();
    client?.activate();
  }

  function subscribeMarket(market) {
    if (!client || !client.active) {
      log('âš ï¸ ë¨¼ì € Connect ë²„íŠ¼ìœ¼ë¡œ ì—°ê²°í•˜ì„¸ìš”');
      return;
    }
    if (currentSub) {
      currentSub.unsubscribe();
      currentSub = null;
    }

    // UI ì´ˆê¸°í™” (ì´ë¦„ì€ ì„œë²„ ê°’ ì˜¤ê¸° ì „ ì„ì‹œê°’)
    const fallbackName = market === 'KRW-ETH' ? 'ì´ë”ë¦¬ì›€' : (market === 'KRW-BTC' ? 'ë¹„íŠ¸ì½”ì¸' : market);
    el('name').innerHTML = fallbackName + ' <span class="code" id="code">(' + market + ')</span>';
    el('price').textContent = '-';
    el('change').textContent = 'ì „ì¼ëŒ€ë¹„ -';
    el('change').className = 'sub';
    el('prev').textContent = 'ì „ì¼ ì¢…ê°€: -';
    el('vol').textContent = 'ëˆ„ì  ê±°ë˜ëŸ‰(24h): -';
    el('time').textContent = '';

    currentSub = client.subscribe('/topic/ticker/' + market, (msg) => {
      try {
        const t = JSON.parse(msg.body);
        // ìƒˆ í•„ë“œë“¤ ë°˜ì˜: marketName, changePrice, prevClose
        const name = t.marketName || fallbackName;
        el('name').innerHTML = `${name} <span class="code" id="code">(${t.market
        || market})</span>`;

        el('price').textContent = fmtPrice(t.tradePrice) + ' ì›';
        const isUp = Number(t.changeRate ?? 0) >= 0;
        el('price').className = 'price ' + (isUp ? 'up' : 'down');

        // ì „ì¼ëŒ€ë¹„: +8,700ì› (+10.50%)
        const changeText = `${fmtWon(t.changePrice)} (${fmtPct(t.changeRate)})`;
        el('change').textContent = 'ì „ì¼ëŒ€ë¹„ ' + changeText;
        el('change').className = 'sub ' + (isUp ? 'up' : 'down');

        el('prev').textContent = 'ì „ì¼ ì¢…ê°€: ' + fmtPrice(t.prevClose) + ' ì›';
        el('vol').textContent = 'ëˆ„ì  ê±°ë˜ëŸ‰(24h): ' + fmtVol(t.accVolume);
        el('time').textContent = new Date(t.tradeTimestamp).toLocaleTimeString();
      } catch (e) {
        log('parse error: ' + e.message);
      }
    }, {id: 'sub-' + market});

    log('ğŸ§· SUBSCRIBED: /topic/ticker/' + market + ' (' + currentTransport + ')');
  }

  // ë²„íŠ¼ ë°”ì¸ë”©
  document.getElementById('btnConnectWs').onclick = connectNative;
  document.getElementById('btnConnectSock').onclick = connectSockJS;
  document.getElementById('btnSubscribe').onclick = () => subscribeMarket(
      document.getElementById('market').value);
  document.getElementById('btnDisconnect').onclick = () => client?.deactivate();
</script>
</body>
</html>